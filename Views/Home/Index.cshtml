@model ReagentBarcode.Models.ReagentInput
@{
    ViewData["Title"] = "Reagent Barcode Generator";
}

<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-barcode me-2"></i>Reagent Barcode Generator
            </h4>
        </div>
        <div class="card-body">
            <div id="alertContainer"></div>

            <form id="barcodeForm" class="row g-3">
                <!-- Row 1: Chemical and Code -->
                <div class="col-md-12">
                    <label for="Chem" class="form-label fw-bold">Chemical Name</label>
                    <select id="Chem" class="form-select border-primary" required>
                        <option value="">-- Select Chemical --</option>
                    </select>
                </div>
                <div class="col-md-4" style="display:none;">
                    <label for="ItemCode" class="form-label fw-bold text-primary">Item Code</label>
                    <input id="ItemCode" class="form-control bg-light fw-bold text-primary" placeholder="Auto-filled" readonly required />
                </div>

                <!-- Row 2: Bottle and Reagent with Codes -->
                <div class="col-md-6">
                    <label for="BottleType" class="form-label">Bottle Type</label>
                    <select id="BottleType" class="form-select">
                        <option value="">- Select -</option>
                    </select>
                </div>
                <div class="col-md-2" style="display:none;">
                    <label for="BottleCode" class="form-label text-muted">Bottle Code</label>
                    <input id="BottleCode" class="form-control bg-light" placeholder="Code" readonly required />
                </div>

                <div class="col-md-6">
                    <label for="RgtType" class="form-label">Reagent Type</label>
                    <select id="RgtType" class="form-select">
                        <option value="">- Select -</option>
                    </select>
                </div>
                <div class="col-md-2" style="display:none;">
                    <label for="ReagentCode" class="form-label text-muted">Rgt Code</label>
                    <input id="ReagentCode" class="form-control bg-light" placeholder="Code" />
                </div>

                <!-- Row 3: Inputs -->
                <div class="col-md-4">
                    <label for="LotNumber" class="form-label fw-bold">Lot Number</label>
                    <input id="LotNumber" class="form-control" placeholder="e.g. 009" required />
                </div>
                <div class="col-md-4">
                    <label for="SerialNumber" class="form-label fw-bold">Serial Number</label>
                    <input id="SerialNumber" class="form-control" placeholder="e.g. 8932" required />
                </div>
                <div class="col-md-4">
                    <label for="ExpDate" class="form-label fw-bold">Expiry Date</label>
                    <input id="ExpDate" class="form-control" placeholder="MM/DD/YYYY or M/D/YYYY" required />
                    <small class="text-muted">Format: MM/DD/YYYY or M/D/YYYY (e.g., 09/30/2025 or 9/30/2025)</small>
                </div>

                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-magic me-2"></i>Generate Barcode
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="clearForm()">
                        <i class="fas fa-redo me-2"></i>Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex align-items-center justify-content-between">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Generated Barcodes
            </h5>
            <button id="printBtn" class="btn btn-light btn-sm" style="display:none;" onclick="printAll()">
                <i class="fas fa-print me-1"></i> Print All
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 20%">Barcode</th>
                            <th style="width: 12%">Chemical</th>
                            <th style="width: 8%">Bottle</th>
                            <th style="width: 8%">Rgt</th>
                            <th style="width: 10%">Lot</th>
                            <th style="width: 10%">Serial</th>
                            <th style="width: 12%">Expiry</th>
                            <th style="width: 5%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                        <tr id="emptyRow">
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                No barcodes generated yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let counter = 0;
        let generatedItems = [];
        let definitions = {};

        // Load definitions on page load
        $(document).ready(function() {
            loadDefinitions();
            checkLicense();
            
            // Set date picker to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            // $("#ExpDate").val(`${mm}/${dd}/${yyyy}`); // Don't auto-fill expiry, let user choose
        });

        function checkLicense() {
            $.ajax({
                url: "/api/barcode/license-status",
                method: "GET",
                success: function(data) {
                    if (!data.IsValid) {
                        const msg = "License Expired. This software was valid for a 28-day trial period. Please contact support.";
                        showAlert(msg, "danger");
                        disableGenerator();
                    } else if (!data.CanGenerate) {
                        const msg = "Daily Limit Reached. You have reached the maximum allowed generations for today (25 prints).";
                        showAlert(msg, "danger");
                        disableGenerator();
                    } else {
                        // All good, maybe show a subtle remaining count?
                        if (data.RemainingToday <= 5) {
                            showAlert(`Daily limit notice: Only ${data.RemainingToday} prints remaining for today.`, "warning");
                        }
                        if (data.RemainingDays <= 7) {
                            showAlert(`License Notice: ${data.RemainingDays} days remaining in your trial period.`, "warning");
                        }
                    }
                }
            });
        }

        function disableGenerator() {
            $("#barcodeForm button[type='submit']").prop("disabled", true).addClass("btn-secondary").removeClass("btn-primary");
            $("#barcodeForm input, #barcodeForm select").prop("disabled", true);
        }

        function loadDefinitions() {
            $.ajax({
                url: "/api/barcode/definitions",
                method: "GET",
                success: function(data) {
                    definitions = data;
                    populateDropdowns();
                },
                error: function(err) {
                    console.error("Failed to load definitions:", err);
                    showAlert("Failed to load definitions", "warning");
                }
            });
        }

        function populateDropdowns() {
            console.log("Populating dropdowns with definitions:", definitions);
            
            // Chemicals
            const chemSelect = $("#Chem");
            const chemicals = definitions.Chemicals || definitions.chemicals || [];
            console.log("Chemicals data:", chemicals);
            chemicals.forEach(function(c) {
                const name = c.Name || c.name;
                const code = c.DefaultCode || c.defaultCode;
                console.log(`Adding chemical: ${name} with code: ${code}`);
                chemSelect.append(`<option value="${name}" data-code="${code}">${name}</option>`);
            });

            // Bottles
            const bottleSelect = $("#BottleType");
            const bottles = definitions.Bottles || definitions.bottles || [];
            console.log("Bottles data:", bottles);
            bottles.forEach(function(b) {
                const name = b.Name || b.name;
                const code = b.Code || b.code;
                console.log(`Adding bottle: ${name} with code: ${code}`);
                bottleSelect.append(`<option value="${name}" data-code="${code}">${name}</option>`);
            });

            // Reagents
            const rgtSelect = $("#RgtType");
            const reagents = definitions.Reagents || definitions.reagents || [];
            console.log("Reagents data:", reagents);
            reagents.forEach(function(r) {
                const name = r.Name || r.name;
                const code = r.Code || r.code;
                console.log(`Adding reagent: ${name} with code: ${code}`);
                rgtSelect.append(`<option value="${name}" data-code="${code}">${name}</option>`);
            });
            
            console.log("Dropdown population complete");
        }

        // Auto-fill events
        $("#Chem").change(function() {
            const code = $(this).find(":selected").data("code");
            if (code) $("#ItemCode").val(code);
        });

        $("#BottleType").change(function() {
            const code = $(this).find(":selected").data("code");
            if (code) $("#BottleCode").val(code);
        });

        $("#RgtType").change(function() {
            const code = $(this).find(":selected").data("code");
            if (code) $("#ReagentCode").val(code);
        });

        $("#barcodeForm").submit(function (e) {
            e.preventDefault();

            // Validate form - Check required fields
            if (!$("#ItemCode").val() || !$("#BottleCode").val() || 
                !$("#LotNumber").val() || !$("#SerialNumber").val() || !$("#ExpDate").val()) {
                showAlert("Please fill in all required fields (Item Code, Bottle Code, Lot, Serial, Expiry)", "warning");
                return;
            }

            const payload = {
                ItemCode: $("#ItemCode").val(),
                BottleCode: $("#BottleCode").val(),
                ReagentCode: $("#ReagentCode").val(),
                // Descriptions
                Chem: $("#Chem").val() || $("#Chem option:selected").text(), // Use selected text if value is empty/custom
                BottleType: $("#BottleType option:selected").text(),
                RgtType: $("#RgtType option:selected").text(),
                LotNumber: $("#LotNumber").val(),
                SerialNumber: $("#SerialNumber").val(),
                ExpDate: $("#ExpDate").val()
            };

            // Show loading state
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Generating...');

            $.ajax({
                url: "/api/barcode/generate",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (data) {
                    addRow(data);
                    showAlert("Barcode generated and copied to clipboard!", "success");
                    // Copy automatically
                    copyBarcode(data.barcodeNumber);
                    submitBtn.prop('disabled', false).html(originalText);
                },
                error: function (err) {
                    const errorMsg = err.responseJSON?.errorMessage || err.responseJSON?.message || "Error generating barcode";
                    showAlert(errorMsg, "danger");
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });
        });

        function addRow(data) {
            console.log("Adding row with data:", data);
            $("#emptyRow").remove();
            counter++;
            
            // Normalize data keys to PascalCase for backend binding
            const item = {
                BarcodeNumber: data.BarcodeNumber || data.barcodeNumber || "",
                Chem: data.Chem || data.chem || "",
                BottleType: data.BottleType || data.bottleType || "",
                GenReagentCode: data.GenReagentCode || data.genReagentCode || data.ReagentCode || data.reagentCode || "", 
                LotNumber: data.LotNumber || data.lotNumber || "",
                ExpDate: data.ExpDate || data.expDate,
                GenItemCode: data.GenItemCode || data.genItemCode || "",
                GenBottleCode: data.GenBottleCode || data.genBottleCode || "",
                SerialNumber: data.SerialNumber || data.serialNumber || ""
            };
            generatedItems.push(item);
            $("#printBtn").fadeIn();

            // Handle both PascalCase and camelCase
            const barcode = data.BarcodeNumber || data.barcodeNumber || "";
            const chem = data.Chem || data.chem || "";
            const bottle = data.BottleType || data.bottleType || "";
            const rgt = data.RgtType || data.rgtType || "";
            const lot = data.LotNumber || data.lotNumber || "";
            const serial = data.SerialNumber || data.serialNumber || "";
            const expDate = data.ExpDate || data.expDate;
            const exp = expDate ? new Date(expDate).toLocaleDateString() : "";

            console.log(`Creating row: Barcode=${barcode}, Chem=${chem}, Bottle=${bottle}`);

            const row = $(`
                <tr>
                    <td>${counter}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <code class="bg-light px-2 py-1 rounded me-2" style="font-size: 1.1em; color: #d63384;">${barcode}</code>
                        </div>
                    </td>
                    <td>${chem}</td>
                    <td><span class="badge bg-info text-dark">${bottle}</span></td>
                    <td><span class="badge bg-warning text-dark">${rgt}</span></td>
                    <td>${lot}</td>
                    <td>${serial}</td>
                    <td>${exp}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-dark" onclick="copyBarcode('${barcode}')" title="Copy barcode">
                            <i class="fas fa-copy"></i>
                        </button>
                    </td>
                </tr>
            `);
            
            $("#resultsTable").prepend(row);
            row.hide().fadeIn(400);
            console.log("Row added successfully");
        }

        function copyBarcode(barcode) {
            if (!barcode) return;
            navigator.clipboard.writeText(barcode).then(function() {
                // Optional: Toast or subtle feedback
            }, function() {
                // Fallback or ignore
            });
        }

        function clearForm() {
            $("#barcodeForm")[0].reset();
            $("#alertContainer").empty();
            // Reset dropdowns trigger change to clear codes?
            $("#ItemCode").val("");
            $("#BottleCode").val("");
            $("#ReagentCode").val("");
        }

        function printAll() {
            if (generatedItems.length === 0) return;

            const btn = $("#printBtn");
            const originalText = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Printing...');

            $.ajax({
                url: "/api/barcode/print",
                method: "POST",
                contentType: "application/json",
                xhrFields: {
                    responseType: 'blob'
                },
                data: JSON.stringify(generatedItems),
                success: function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "Barcodes_" + new Date().toISOString().slice(0,10) + ".pdf";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert("PDF generated successfully!", "success");
                    btn.prop('disabled', false).html(originalText);
                },
                error: function(err) {
                    console.error(err);
                    showAlert("Failed to generate PDF", "danger");
                    btn.prop('disabled', false).html(originalText);
                }
            });
        }

        function showAlert(msg, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <strong>${type === 'success' ? 'Success!' : 'Notice:'}</strong> ${msg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $("#alertContainer").html(alertHtml);
            
            setTimeout(function() {
                $(".alert").fadeOut(500, function() { $(this).remove(); });
            }, 5000);
        }
    </script>

}
